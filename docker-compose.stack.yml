# =============================================================================
# VOXPOP - Docker Stack Configuration for Production (Portainer/Swarm)
# =============================================================================
# Domínio: voxpop.tratto.solutions
#
# Este arquivo é usado para fazer deploy da aplicação em produção via
# Portainer/Docker Swarm com Traefik como load balancer e proxy reverso.
#
# **IMPORTANTE:**
# - Esta stack usa PostgreSQL EXTERNO (não cria container de banco)
# - Cria container Redis para cache/broker
#
# Antes de fazer deploy:
# 1. Build das imagens: ./build-images.sh
# 2. Criar volumes externos: ver seção DEPLOYMENT.md
# 3. Configurar variáveis de ambiente no Portainer
#
# Documentação completa: DEPLOYMENT.md
# =============================================================================

version: '3.8'

services:
  # =============================================================================
  # FRONTEND - React/Vite com Nginx
  # =============================================================================
  voxpop-frontend:
    image: lpcoutinho/voxpop-frontend:latest
    environment:
      - NODE_ENV=production
    networks:
      - LaunchNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        monitor: 60s
        max_failure_ratio: 0.3
      labels:
        # --- Traefik Configuration ---
        - "traefik.enable=true"
        - "traefik.docker.network=LaunchNet"

        # --- Main Router HTTPS ---
        - "traefik.http.routers.voxpop-frontend.rule=Host(`voxpop.tratto.solutions`)"
        - "traefik.http.routers.voxpop-frontend.entrypoints=websecure"
        - "traefik.http.routers.voxpop-frontend.service=voxpop-frontend"
        - "traefik.http.routers.voxpop-frontend.tls=true"
        - "traefik.http.routers.voxpop-frontend.tls.certresolver=letsencryptresolver"

        # --- HTTP to HTTPS Redirect ---
        - "traefik.http.routers.voxpop-frontend-http.rule=Host(`voxpop.tratto.solutions`)"
        - "traefik.http.routers.voxpop-frontend-http.entrypoints=web"
        - "traefik.http.routers.voxpop-frontend-http.middlewares=redirect-to-https"

        # --- Middleware ---
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
        - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

        # --- Service Configuration ---
        - "traefik.http.services.voxpop-frontend.loadbalancer.server.port=80"
        - "traefik.http.services.voxpop-frontend.loadbalancer.passHostHeader=true"
        - "traefik.http.services.voxpop-frontend.loadbalancer.healthcheck.path=/health"
        - "traefik.http.services.voxpop-frontend.loadbalancer.healthcheck.interval=30s"
        - "traefik.http.services.voxpop-frontend.loadbalancer.healthcheck.timeout=3s"

  # =============================================================================
  # BACKEND - Django REST Framework
  # =============================================================================
  voxpop-backend:
    image: lpcoutinho/voxpop-backend:latest
    command: >
      sh -c "
      python manage.py migrate --noinput &&
      python manage.py collectstatic --noinput &&
      gunicorn config.wsgi:application
      --bind 0.0.0.0:8000
      --workers 4
      --threads 2
      --timeout 120
      --worker-class sync
      --max-requests 1000
      --max-requests-jitter 50
      --access-logfile -
      --error-logfile -
      --log-level info
      "
    environment:
      # --- Django Core ---
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - PYTHONUNBUFFERED=1
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=0
      - ALLOWED_HOSTS=voxpop.tratto.solutions,localhost,127.0.0.1

      # --- Database EXTERNO (PostgreSQL) ---
      # Configure POSTGRES_HOST para apontar para o servidor PostgreSQL existente
      # Pode ser: IP, hostname, ou nome de serviço Docker se estiver na mesma rede
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-voxpop_prod}
      - POSTGRES_USER=${POSTGRES_USER:-voxpop}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

      # --- Redis (Container nesta stack) ---
      - REDIS_URL=redis://voxpop-redis:6379/0
      - CELERY_BROKER_URL=redis://voxpop-redis:6379/1

      # --- Evolution API ---
      - EVOLUTION_API_URL=${EVOLUTION_API_URL:-https://evolution.tratto.solutions}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}

      # --- Email/SMTP ---
      - MAILER_SENDER_EMAIL=${MAILER_SENDER_EMAIL}
      - SMTP_DOMAIN=${SMTP_DOMAIN}
      - SMTP_ADDRESS=${SMTP_ADDRESS}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USERNAME=${SMTP_USERNAME}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
      - SMTP_AUTHENTICATION=plain
      - SMTP_ENABLE_STARTTLS_AUTO=true

      # --- Frontend/CORS ---
      - FRONTEND_URL=https://voxpop.tratto.solutions
      - VITE_API_URL=https://voxpop.tratto.solutions/api
      - CORS_ALLOWED_ORIGINS=https://voxpop.tratto.solutions

    volumes:
      - voxpop_logs:/app/logs
    networks:
      - LaunchNet
    depends_on:
      - voxpop-redis
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      rollback_config:
        parallelism: 1
        delay: 0s
        failure_action: pause
        order: stop-first
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      labels:
        # --- Traefik Configuration ---
        - "traefik.enable=true"
        - "traefik.docker.network=LaunchNet"

        # --- API Router ---
        - "traefik.http.routers.voxpop-api.rule=Host(`voxpop.tratto.solutions`) && PathPrefix(`/api`)"
        - "traefik.http.routers.voxpop-api.entrypoints=websecure"
        - "traefik.http.routers.voxpop-api.tls.certresolver=letsencryptresolver"
        - "traefik.http.routers.voxpop-api.priority=2"
        - "traefik.http.routers.voxpop-api.service=voxpop-api"

        # --- Service Configuration ---
        - "traefik.http.services.voxpop-api.loadbalancer.server.port=8000"
        - "traefik.http.services.voxpop-api.loadbalancer.passHostHeader=true"

        # --- Middleware ---
        - "traefik.http.middlewares.voxpop-sslheader.headers.customrequestheaders.X-Forwarded-Proto=https"
        - "traefik.http.routers.voxpop-api.middlewares=voxpop-sslheader"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # =============================================================================
  # CELERY WORKER - Background Tasks
  # =============================================================================
  voxpop-celery:
    image: lpcoutinho/voxpop-backend:latest
    command: >
      celery -A config worker
      --loglevel=info
      --concurrency=4
      --max-tasks-per-child=1000
      --queues=default,campaigns,messages_high,messages_low,webhooks,analytics
    environment:
      # --- Django Core ---
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - PYTHONUNBUFFERED=1
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=0

      # --- Database EXTERNO (PostgreSQL) ---
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-voxpop_prod}
      - POSTGRES_USER=${POSTGRES_USER:-voxpop}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

      # --- Redis (Container nesta stack) ---
      - REDIS_URL=redis://voxpop-redis:6379/0
      - CELERY_BROKER_URL=redis://voxpop-redis:6379/1

      # --- Evolution API ---
      - EVOLUTION_API_URL=${EVOLUTION_API_URL:-https://evolution.tratto.solutions}
      - EVOLUTION_API_KEY=${EVOLUTION_API_KEY}

    volumes:
      - voxpop_logs:/app/logs
    networks:
      - LaunchNet
    depends_on:
      - voxpop-redis
      - voxpop-backend
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.3'
    healthcheck:
      test: ["CMD", "celery", "-A", "config", "inspect", "ping"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # CELERY BEAT - Scheduled Tasks
  # =============================================================================
  voxpop-celery-beat:
    image: lpcoutinho/voxpop-backend:latest
    command: >
      celery -A config beat
      --loglevel=info
      --scheduler django_celery_beat.schedulers:DatabaseScheduler
    environment:
      # --- Django Core ---
      - DJANGO_SETTINGS_MODULE=config.settings.production
      - PYTHONUNBUFFERED=1

      # --- Database EXTERNO (PostgreSQL) ---
      - POSTGRES_HOST=${POSTGRES_HOST}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-voxpop_prod}
      - POSTGRES_USER=${POSTGRES_USER:-voxpop}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}

      # --- Redis (Container nesta stack) ---
      - REDIS_URL=redis://voxpop-redis:6379/0
      - CELERY_BROKER_URL=redis://voxpop-redis:6379/1

    volumes:
      - voxpop_logs:/app/logs
    networks:
      - LaunchNet
    depends_on:
      - voxpop-redis
      - voxpop-backend
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      resources:
        limits:
          memory: 256M
          cpus: '0.3'
        reservations:
          memory: 128M
          cpus: '0.1'
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep celerybeat"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =============================================================================
  # REDIS - Message Broker & Cache (Container nesta stack)
  # =============================================================================
  voxpop-redis:
    image: redis:7-alpine
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    volumes:
      - voxpop_redis_data:/data
    networks:
      - LaunchNet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 3
        window: 120s
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.1'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 5

# =============================================================================
# VOLUMES (External)
# =============================================================================
# NOTA: voxpop_postgres_data foi removido pois usamos PostgreSQL EXTERNO
volumes:
  voxpop_redis_data:
    external: true
    name: voxpop_redis_data
  voxpop_logs:
    external: true
    name: voxpop_logs

# =============================================================================
# NETWORKS (External)
# =============================================================================
networks:
  LaunchNet:
    external: true
    name: LaunchNet

# =============================================================================
# NOTAS IMPORTANTES - PostgreSQL Externo
# =============================================================================
#
# Esta configuração NÃO cria um container PostgreSQL. Você deve configurar
# as seguintes variáveis de ambiente no Portainer:
#
# 1. POSTGRES_HOST
#    - Hostname/IP do servidor PostgreSQL existente
#    - Exemplo: "postgres.meudominio.com" ou "192.168.1.100"
#
# 2. POSTGRES_PORT (opcional, padrão: 5432)
#    - Porta do PostgreSQL
#
# 3. POSTGRES_DB (opcional, padrão: voxpop_prod)
#    - Nome do banco de dados
#    - O banco deve ser criado ANTES do deploy
#
# 4. POSTGRES_USER (opcional, padrão: voxpop)
#    - Usuário do PostgreSQL
#
# 5. POSTGRES_PASSWORD (OBRIGATÓRIO)
#    - Senha do usuário PostgreSQL
#
# Antes do deploy, certifique-se de:
# 1. O banco de dados existe no servidor PostgreSQL
# 2. O usuário tem permissões no banco
# 3. O firewall permite conexão dos containers para o PostgreSQL
# 4. As variáveis de ambiente estão configuradas corretamente
#
# Exemplo de variáveis no Portainer:
#   POSTGRES_HOST: postgres.meudominio.com
#   POSTGRES_PORT: 5432
#   POSTGRES_DB: voxpop_prod
#   POSTGRES_USER: voxpop
#   POSTGRES_PASSWORD: sua_senha_segura_aqui
# =============================================================================
